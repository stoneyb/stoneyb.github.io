name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache bust assets
        run: |
          # Get short commit SHA for cache busting
          VERSION=$(git rev-parse --short HEAD)
          echo "Cache busting with version: ${VERSION}"

          # Update CSS link with version
          # First remove any existing version parameter, then add new one
          sed -i "s|href=\"styles/main.css?v=[^\"]*\"|href=\"styles/main.css?v=${VERSION}\"|g" index.html
          sed -i "s|href=\"styles/main.css\"|href=\"styles/main.css?v=${VERSION}\"|g" index.html

          # Update JS files with version
          # First remove any existing version parameter, then add new one
          sed -i "s|src=\"js/history.js?v=[^\"]*\"|src=\"js/history.js?v=${VERSION}\"|g" index.html
          sed -i "s|src=\"js/history.js\"|src=\"js/history.js?v=${VERSION}\"|g" index.html

          sed -i "s|src=\"js/commands.js?v=[^\"]*\"|src=\"js/commands.js?v=${VERSION}\"|g" index.html
          sed -i "s|src=\"js/commands.js\"|src=\"js/commands.js?v=${VERSION}\"|g" index.html

          sed -i "s|src=\"js/matrix.js?v=[^\"]*\"|src=\"js/matrix.js?v=${VERSION}\"|g" index.html
          sed -i "s|src=\"js/matrix.js\"|src=\"js/matrix.js?v=${VERSION}\"|g" index.html

          sed -i "s|src=\"js/snake.js?v=[^\"]*\"|src=\"js/snake.js?v=${VERSION}\"|g" index.html
          sed -i "s|src=\"js/snake.js\"|src=\"js/snake.js?v=${VERSION}\"|g" index.html

          sed -i "s|src=\"js/terminal.js?v=[^\"]*\"|src=\"js/terminal.js?v=${VERSION}\"|g" index.html
          sed -i "s|src=\"js/terminal.js\"|src=\"js/terminal.js?v=${VERSION}\"|g" index.html

          # Verify changes
          echo "Updated index.html:"
          grep -E "(href=\"styles/main.css|src=\"js/)" index.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
